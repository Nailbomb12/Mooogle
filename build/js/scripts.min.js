"use strict";var favoritesFilms=document.querySelector(".favorites-films"),favoritesSerials=document.querySelector(".favorites-serials"),favfilmTxt=document.querySelector(".fav-filmtxt"),favSerialTxt=document.querySelector(".fav-serialtxt"),favorites=document.querySelector(".favorites"),idArr=[],statuWindow=document.querySelector(".status-window"),statusWindowTxt=document.querySelector(".status-window__txt"),addToFavorites=function(e,t,a){event.stopPropagation(),idArr.includes(e)||(idArr.push(e),getCurrentCard(e,t),statuWindow.innerHTML='<p class = "status-window__txt--bold">'+a+'</p><p class = "status-window__txt">Добавленно в избранное</p>',toFav(event.clientY,event.clientX))};function toFav(e,t){statuWindow.style.top=e+40+"px",statuWindow.style.left=t-150+"px",statuWindow.style.display="block",setTimeout("statuWindow.style.display = 'none'",1500)}Array.prototype.remove=function(e){var t=this.indexOf(e);return-1!=t&&this.splice(t,1)};var removeFromFavorites=function(e){tabLinks.forEach(function(t){t.classList.contains("category-item--active")&&"#pane-3"===t.hash&&(idArr.remove(e),event.currentTarget.parentNode.remove(),statuWindow.innerHTML='<p class = "status-window__txt">Удалено из избранного</p>',toFav(event.clientY,event.clientX))})},getCurrentCard=function(e,t){axios.get("https://api.themoviedb.org/3/"+t+"/"+e+"?language=ru-RU&api_key="+apiKey).then(function(e){"movie"===t&&addCardToFav(e.data,favoritesFilms,compiled),"tv"===t&&addCardToFav(e.data,favoritesSerials,compil)}).catch(function(e){console.log(e)})},htmlTplRev=document.querySelector("#reviewBlock").textContent.trim(),compileded=_.template(htmlTplRev),addNewReview=function(e,t,a){t.insertAdjacentHTML("afterbegin",a(e))},reviewsArr=null!==localStorage.getItem("revObj")?JSON.parse(localStorage.getItem("revObj")):[],formHandler=function(e){setTimeout(function(){var t=document.querySelector(".mainform"),a=document.querySelector("#user-name"),i=document.querySelector("#user-review"),s=document.querySelector(".main-reviews-container"),r=(new Date).toLocaleString("ru").slice(0,-10),o={id:e,comment:{userName:a.value,userReview:i.value,userDate:r}},n=o.comment,c=n.userName,l=n.userReview,d=n.userDate;addNewReview({userDate:d,userName:c,userReview:l},s,compileded),reviewsArr.push(o);var u=JSON.stringify(reviewsArr);localStorage.setItem("revObj",u),t.reset()},300)},reviewsRender=function(e){setTimeout(function(){var t=document.querySelector(".main-reviews-container"),a=JSON.parse(localStorage.getItem("revObj"));null!==localStorage.getItem("revObj")&&a.map(function(a){if(a.id===e){var i=a.comment,s=i.userName,r=i.userReview,o=i.userDate;addNewReview({userDate:o,userName:s,userReview:r},t,compileded)}})},500)},pageButtons=document.querySelector(".page-switcher-panel"),allButtons=document.querySelectorAll(".page-switcher-panel>button");allButtons[0].classList.add("page-active");var pageSwitcher=function(e){if(e.target!==e.currentTarget){var t=e.target.textContent;tabLinks.forEach(function(e){e.classList.contains("category-item--active")&&"#pane-1"===e.hash&&getPopular("movie",result,compiled,t),e.classList.contains("category-item--active")&&"#pane-2"===e.hash&&getPopular("tv",serials,compil,t)}),allButtons.forEach(function(e){return e.classList.remove("page-active")}),e.target.classList.add("page-active"),window.scrollTo(0,0)}};pageButtons.addEventListener("click",pageSwitcher);var result=document.querySelector(".videos"),htmlTempl=document.querySelector("#Extendcard").textContent.trim(),compile=_.template(htmlTempl),htmlTpl=document.querySelector("#card").textContent.trim(),compiled=_.template(htmlTpl),htmlTplTV=document.querySelector("#cardTV").textContent.trim(),compil=_.template(htmlTplTV),htmlTemplTvCard=document.querySelector("#ExtendcardTV").textContent.trim(),compileTvCard=_.template(htmlTemplTvCard),apiKey="532f680f186ee3009db06b2e2efe9aab",updateView=function(e,t,a){var i="";e.forEach(function(e){i+=a(e)}),t.innerHTML=i},addCardToFav=function(e,t,a){t.innerHTML+=a(e)},getPopular=function(e,t,a,i){axios.get("https://api.themoviedb.org/3/"+e+"/popular?api_key="+apiKey+"&language=ru-RU&page="+i).then(function(e){updateView(e.data.results,t,a)}).catch(function(e){console.log(e)})},searchFailMessage=function(e,t){0===e.length&&(t.innerHTML='<p class="search-error">По вашему запросу ничего не найдено :(</p>')},searchByName=function(e,t,a){axios.get("https://api.themoviedb.org/3/search/"+t+"?include_adult=false&page=1&query="+e+"&language=ru-RU&api_key="+apiKey).then(function(e){var t=e.data.results;document.querySelectorAll(".category-item").forEach(function(e){e.classList.contains("category-item--active")&&"#pane-1"===e.hash&&t.length>0?updateView(t,result,a):searchFailMessage(t,result),e.classList.contains("category-item--active")&&"#pane-2"===e.hash&&t.length>0?updateView(t,serials,a):searchFailMessage(t,serials)})}).catch(function(e){console.log(e)})},tabFavorRender=function(e){tabLinks.forEach(function(t){t.classList.contains("category-item--active")&&"#pane-3"===t.hash&&(tabsPane[e].classList.add("tabs__pane--active"),tabsPane[2].classList.remove("tabs__pane--active"))})},tabFavorBackRender=function(){tabLinks.forEach(function(e){e.classList.contains("category-item--active")&&"#pane-3"===e.hash&&(tabsPane[2].classList.add("tabs__pane--active"),tabsPane[1].classList.remove("tabs__pane--active"),tabsPane[0].classList.remove("tabs__pane--active"))})},showMovie=function(e){renderFullCard(e,"movie"),tabFavorRender(0)},showTV=function(e){renderFullCardTV(e,"tv"),tabFavorRender(1)},updateViewMovieCard=function(e,t,a){var i=a(e);t.innerHTML=i},renderFullCard=function(e,t){axios.get("https://api.themoviedb.org/3/"+t+"/"+e+"?language=ru-RU&api_key="+apiKey).then(function(e){var a=e.data,i=a.genres,s=a.overview,r=a.poster_path,o=a.production_countries,n=a.release_date,c=a.runtime,l=a.tagline,d=a.title,u=a.id;axios.get("https://api.themoviedb.org/3/"+t+"/"+u+"/images?api_key="+apiKey).then(function(e){var a=e.data.backdrops;axios.get("https://api.themoviedb.org/3/"+t+"/"+u+"/credits?language=ru-RU&api_key="+apiKey).then(function(e){var v=e.data,m=v.cast,p=v.crew;axios.get("https://api.themoviedb.org/3/"+t+"/"+u+"/videos?api_key="+apiKey).then(function(e){var t=e.data.results[0].key;updateViewMovieCard({title:d,genres:i,overview:s,poster:r,countries:o,date:n,runtime:c,tagline:l,backdrops:a,cast:m,crew:p,key:t,id:u},result,compile),reviewsRender(u),pageButtons.style.display="none"})}).catch(function(e){console.log(e)})}).catch(function(e){console.log(e)})}).catch(function(e){console.log(e)})},renderFullCardTV=function(e,t){axios.get("https://api.themoviedb.org/3/"+t+"/"+e+"?language=ru-RU&api_key="+apiKey).then(function(e){var a=e.data,i=a.name,s=a.genres,r=a.overview,o=a.poster_path,n=a.origin_country,c=a.first_air_date,l=a.episode_run_time,d=a.created_by,u=a.number_of_seasons,v=a.last_air_date,m=a.number_of_episodes,p=a.original_name,h=a.homepage,g=a.id;axios.get("https://api.themoviedb.org/3/"+t+"/"+g+"/images?api_key="+apiKey).then(function(e){var a=e.data.backdrops;axios.get("https://api.themoviedb.org/3/"+t+"/"+g+"/credits?language=ru-RU&api_key="+apiKey).then(function(e){var f=e.data.cast;axios.get("https://api.themoviedb.org/3/"+t+"/"+g+"/videos?api_key="+apiKey).then(function(e){var t=e.data.results[0].key;updateViewMovieCard({title:i,date:c,poster:o,backdrops:a,countries:n,cast:f,created_by:d,genres:s,runtime:l,overview:r,key:t,number_of_seasons:u,last_air_date:v,number_of_episodes:m,original_name:p,homepage:h,id:g},serials,compileTvCard),reviewsRender(g),pageButtons.style.display="none"})}).catch(function(e){console.log(e)})}).catch(function(e){console.log(e)})}).catch(function(e){console.log(e)})},onBackButtonHandler=function(){document.querySelectorAll(".category-item").forEach(function(e){e.classList.contains("category-item--active")&&"#pane-1"===e.hash&&allButtons.forEach(function(e){if(e.classList.contains("page-active")){var t=e.textContent;getPopular("movie",result,compiled,t),pageButtons.style.display="block"}}),e.classList.contains("category-item--active")&&"#pane-2"===e.hash&&allButtons.forEach(function(e){if(e.classList.contains("page-active")){var t=e.textContent;getPopular("tv",serials,compil,t),pageButtons.style.display="block"}}),e.classList.contains("category-item--active")&&"#pane-3"===e.hash&&(tabFavorBackRender(),window.scrollTo(0,0))})};getPopular("movie",result,compiled,"1");var menu=document.querySelector(".header__menu"),stub=document.querySelector(".stub"),aside=document.querySelector(".aside"),asideList=document.querySelector(".aside__list"),asideItem=document.querySelectorAll(".aside__item"),asideLink=document.querySelectorAll(".aside__link"),tabs=document.querySelector(".category-list"),tabLinks=document.querySelectorAll(".category-item"),tabsPane=document.querySelectorAll(".tabs__pane"),serials=document.querySelector(".tv-serials"),hiddenBlockIcon=document.querySelector(".hidden-search"),hiddenSearchBtn=document.querySelector(".hidden__form-send"),hiddenBlock=document.querySelector(".hidden");favoritesFilms=document.querySelector(".favorites-films"),favoritesSerials=document.querySelector(".favorites-serials");tabLinks[0].classList.add("category-item--active"),tabsPane[0].classList.add("tabs__pane--active");var toggleAside=function(){aside.classList.toggle("js-show-aside"),stub.classList.add("js-show-stub"),document.body.classList.add("ovfh")};menu.addEventListener("click",toggleAside);var toggleHiddenBlock=function(){hiddenBlock.classList.toggle("js-show-hidden"),stub.classList.add("js-show-stub"),document.body.classList.add("ovfh")};hiddenBlockIcon.addEventListener("click",toggleHiddenBlock);var hideBlocks=function(e){stub.classList.contains("js-show-stub")&&(hiddenBlock.classList.remove("js-show-hidden"),aside.classList.remove("js-show-aside"),stub.classList.remove("js-show-stub"),document.body.classList.remove("ovfh"))};stub.addEventListener("click",hideBlocks);var searchBtn=document.querySelector(".idBtn"),idInput=document.querySelector("#idInput"),hiddenSearchId=document.querySelector("#hiddenSearchId"),header=document.querySelector(".header"),searchSwitcher=function(e){document.querySelectorAll(".category-item").forEach(function(t){t.classList.contains("category-item--active")&&"#pane-1"===t.hash&&(searchByName(e,"movie",compiled),pageButtons.style.display="none"),t.classList.contains("category-item--active")&&"#pane-2"===t.hash&&(searchByName(e,"tv",compil),pageButtons.style.display="none")})},mainSearch=function(e){e.preventDefault(0),searchSwitcher(idInput.value),""!==idInput.value&&(idInput.value="")},mobileSearch=function(e){e.preventDefault(0),searchSwitcher(hiddenSearchId.value),""!==hiddenSearchId.value&&(hideBlocks(),hiddenSearchId.value="")};searchBtn.addEventListener("click",mainSearch),hiddenSearchBtn.addEventListener("click",mobileSearch);var switchTabs=function(e){if(e.preventDefault(),e.target!==tabs){tabLinks.forEach(function(e){return e.classList.remove("category-item--active")}),e.target.classList.add("category-item--active"),tabsPane.forEach(function(e){return e.classList.remove("tabs__pane--active")});var t=!0,a=!1,i=void 0;try{for(var s,r=tabsPane[Symbol.iterator]();!(t=(s=r.next()).done);t=!0){var o=s.value;e.target.getAttribute("href")==="#"+o.id&&o.classList.add("tabs__pane--active"),"#pane-1"===e.target.getAttribute("href")&&getPopular("movie",result,compiled,"1"),pageButtons.style.display="block","#pane-2"===e.target.getAttribute("href")&&getPopular("tv",serials,compil,"1"),pageButtons.style.display="block",allButtons.forEach(function(e){return e.classList.remove("page-active")}),allButtons[0].classList.add("page-active"),"#pane-3"===e.target.getAttribute("href")&&(0!==idArr.length&&(favfilmTxt.textContent="Фильмы",goldenStars(favoritesFilms)),0!==idArr.length&&(favSerialTxt.textContent="Сериалы",goldenStars(favoritesSerials)),pageButtons.style.display="none")}}catch(e){a=!0,i=e}finally{try{!t&&r.return&&r.return()}finally{if(a)throw i}}}};tabs.addEventListener("click",switchTabs);var goldenStars=function(e){e.querySelectorAll(".icon").forEach(function(e){e.classList.add("gold-icon")})},switchAsideCategorys=function(e){e.preventDefault(),e.target.classList.contains("aside__link")&&tabsPane.forEach(function(t,a){e.target.getAttribute("href")!==tabLinks[a].getAttribute("href")&&(tabLinks[a].classList.remove("category-item--active"),t.classList.remove("tabs__pane--active")),e.target.getAttribute("href")==="#"+t.id&&e.target.getAttribute("href")===tabLinks[a].getAttribute("href")&&(t.classList.add("tabs__pane--active"),tabLinks[a].classList.add("category-item--active"),hideBlocks()),"#pane-2"===e.target.getAttribute("href")&&getPopular("tv",serials,compil,"1")})};asideList.addEventListener("click",switchAsideCategorys);